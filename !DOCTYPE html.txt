<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ストレスチェックアプリ（57項目版）</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for Radar Chart and Scatter Plot -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* WordPressテーマのCSSとの競合を避けるため、bodyのスタイルを強制的にリセット */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important; /* Ensure html and body take full width */
            height: 100% !important; /* Ensure html and body take full height */
            box-sizing: border-box !important;
            overflow-x: hidden !important; /* 強制的に横スクロールバーを非表示 */
        }
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5; /* クリーンな見た目のための非常に薄いグレーの背景 */
        }

        /* 新しい最上位のラッパーを追加し、強制的に中央配置を試みる */
        #stress-check-outer-wrapper {
            width: 100vw; /* ビューポートの幅全体を使用 */
            max-width: 100vw; /* ビューポートの幅全体を使用 */
            margin: 0 auto !important; /* 強制的に中央に配置 */
            box-sizing: border-box !important;
            padding: 0; /* 内部のapp-wrapperでパディングを管理 */
            /* より強力な中央揃えの試み */
            position: relative; /* transformの基準 */
            left: 50%;
            transform: translateX(-50%);
            display: block; /* block要素であることを確認 */
        }

        /* コンテナを中央に配置するための新しいラッパー */
        .app-wrapper {
            display: flex;
            flex-direction: column; /* コンテンツを垂直に積み重ねる */
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* ビューポートの高さ全体を使用 */
            width: 100%; /* 親のouter-wrapperの幅を使用 */
            max-width: 900px; /* アプリ全体の最大幅をここで制御 */
            margin: 0 auto; /* ラッパー自体を中央に配置 */
            box-sizing: border-box; /* パディングとボーダーを幅の計算に含める */
            padding: 20px; /* bodyのパディングをここに移動 */
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px; /* より丸い角 */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08); /* 柔らかく深い影 */
            width: 100%; /* 親のapp-wrapperの幅を使用 */
            border: 1px solid #e0e6ed; /* 微妙なボーダー */
            overflow: hidden; /* トランジションでのオーバーフロー問題を確実に防ぐ */
            margin: 0 auto; /* 親要素内でコンテナを中央に配置 */
            box-sizing: border-box; /* パディングとボーダーを幅の計算に含める */
        }
        h1 {
            color: #1a202c; /* 見出しの濃いテキスト */
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2.2em; /* 大きい見出し */
        }
        .footer-note {
            margin-top: 25px;
            font-size: 0.85em;
            color: #718096;
            text-align: center;
            line-height: 1.5;
        }

        /* プログレスバー */
        .progress-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 10px;
            height: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3b82f6; /* 青いプログレスバー */
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }

        /* フォームステップ */
        /* form-stepからposition: absolute/relativeを削除し、シンプルなレイアウトにする */
        .form-step {
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            display: none; /* デフォルトで非表示 */
            width: 100%; /* 親要素（フォーム）の全幅を使用 */
        }
        .form-step.active {
            opacity: 1;
            display: block; /* アクティブなステップを表示 */
        }

        /* フォーム要素自体 */
        #stressCheckForm {
            width: 100%;
            max-width: 800px; /* フォームコンテンツの最大幅を制御 */
            margin: 0 auto; /* コンテナ内でフォームを中央に配置 */
            min-height: 600px; /* フォームエリアの最小高さを維持 */
            box-sizing: border-box; /* パディングを幅の計算に含める */
        }

        .question-section {
            margin-bottom: 25px; /* セクション間のスペースを広げる */
            padding: 20px;
            background-color: #f8fafc; /* セクションの非常に薄い背景 */
            border-radius: 12px;
            border: 1px solid #edf2f7; /* 非常に微妙なボーダー */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03); /* 奥行きのための薄い影 */
        }
        .question-section h3 {
            font-size: 1.4em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0; /* セクションタイトルの区切り線 */
            padding-bottom: 10px;
        }
        .question-text {
            font-weight: 500; /* やや軽いフォントウェイト */
            margin-bottom: 12px;
            color: #4a5568;
            font-size: 1.05em;
        }
        .options label {
            display: flex; /* より良い配置のためにフレックスを使用 */
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 10px;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            color: #4a5568;
            border: 1px solid #e2e8f0; /* 各オプションのボーダー */
        }
        .options label:hover {
            background-color: #f0f4f8; /* ホバー時に明るい背景 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* ホバー時に微妙な影 */
        }
        .options input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.1); /* ラジオボタンをわずかに大きくする */
            accent-color: #3b82f6; /* 青いアクセント */
        }

        /* ナビゲーションボタン */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px; /* ボタン間のスペース */
        }
        .navigation-buttons button {
            flex: 1; /* ボタンを同じ幅にする */
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .navigation-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .navigation-buttons button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .navigation-buttons .prev-button {
            background-color: #cbd5e0; /* 「戻る」ボタンの薄いグレー */
            color: #2d3748;
        }
        .navigation-buttons .prev-button:hover {
            background-color: #a0aec0;
        }
        .navigation-buttons .next-button,
        .navigation-buttons .submit-button {
            background-color: #3b82f6; /* 「次へ/送信」ボタンの青 */
            color: white;
        }
        .navigation-buttons .next-button:hover,
        .navigation-buttons .submit-button:hover {
            background-color: #2563eb;
        }
        .navigation-buttons button:disabled {
            background-color: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 結果セクション */
        .result-section {
            margin-top: 30px;
            padding: 30px;
            background-color: #e6fffa;
            border-radius: 20px;
            border: 1px solid #b2f5ea;
            text-align: center;
            color: #2d3748;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        .result-section h2 {
            color: #2c5282;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.8em;
        }
        .result-score {
            font-size: 3em; /* スコア表示を大きくする */
            font-weight: 800;
            color: #38b2ac;
            margin-bottom: 15px;
        }
        .result-message {
            font-size: 1.2em;
            line-height: 1.7;
            margin-bottom: 20px;
            color: #2d3748;
        }
        .result-details {
            text-align: left;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        .result-details h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c5282;
            margin-bottom: 15px;
        }
        .result-details p {
            margin-bottom: 8px;
            font-size: 1.05em;
            color: #4a5568;
        }
        .chart-container {
            width: 100%;
            max-width: 500px; /* チャートサイズを制限 */
            height: 400px; /* アスペクト比を制御するために固定高さを追加 */
            margin: 30px auto 0;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px; /* チャート間のスペース */
        }
        /* カスタムメッセージボックス */
        #customMessageBox {
            background-color: rgba(0, 0, 0, 0.6); /* 暗いオーバーレイ */
        }
        #customMessageBox > div {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            color: #2d3748;
        }
        #customMessageBox p {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        #customMessageBox button {
            background-color: #3b82f6;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        #customMessageBox button:hover {
            background-color: #2563eb;
        }

        /* 散布図固有のスタイル */
        .scatter-plot-container {
            width: 100%;
            max-width: 500px;
            height: 400px; /* アスペクト比を制御するために固定高さを追加 */
            margin: 30px auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            position: relative; /* 象限ラベル用 */
        }
        .quadrant-label {
            position: absolute;
            font-size: 0.9em;
            font-weight: 600;
            color: #4a5568;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 5px;
            pointer-events: none; /* キャンバスへのクリックを透過させる */
            white-space: nowrap;
        }
        /* 各象限ラベルの特定の位置決め */
        #quantityControlQuadrantLabel1 { top: 10%; right: 5%; } /* 高X-低Y */
        #quantityControlQuadrantLabel2 { top: 10%; left: 5%; }  /* 低X-低Y */
        #quantityControlQuadrantLabel3 { bottom: 5%; left: 5%; } /* 低X-高Y */
        #quantityControlQuadrantLabel4 { bottom: 5%; right: 5%; } /* 高X-高Y */

        /* サポート散布図用 */
        #supportQuadrantLabel1 { top: 10%; right: 5%; } /* 高X-高Y */
        #supportQuadrantLabel2 { top: 10%; left: 5%; }  /* 低X-高Y */
        #supportQuadrantLabel3 { bottom: 5%; left: 5%; } /* 低X-低Y */
        #supportQuadrantLabel4 { bottom: 5%; right: 5%; } /* 高X-低Y */

    </style>
</head>
<body>
    <!-- WordPress環境で中央に配置するためのラッパーdivを追加 -->
    <div id="stress-check-outer-wrapper">
        <div class="app-wrapper">
            <div class="container">
                <h1>ストレスチェック</h1>
                <p class="footer-note mb-6">
                    このアプリは、厚生労働省の「新職業性ストレス簡易調査票（57項目）」の概念に基づいたサンプルです。<br>
                    **実際のストレスチェックの質問項目、評価基準、および実施方法は、厚生労働省の公式ガイドラインをご確認ください。**<br>
                    本アプリの質問は、公式ガイドラインの項目を参考に作成された模擬的なものです。
                </p>

                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <form id="stressCheckForm">
                    <!-- Step 1: 領域I - 仕事のストレス要因 (1/2) - Q1-Q8 -->
                    <div class="form-step active" id="step-1">
                        <div class="question-section">
                            <h3>ステップ1/8: 領域I - 仕事のストレス要因 (1/2)</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q1. 非常にたくさんの仕事をしなければならない</p>
                                <div class="options">
                                    <label><input type="radio" name="q1" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q1" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q1" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q1" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q2. 時間内に仕事が処理しきれない</p>
                                <div class="options">
                                    <label><input type="radio" name="q2" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q2" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q2" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q2" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q3. 一生懸命働かなければならない</p>
                                <div class="options">
                                    <label><input type="radio" name="q3" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q3" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q3" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q3" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q4. かなり注意を集中する必要がある</p>
                                <div class="options">
                                    <label><input type="radio" name="q4" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q4" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q4" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q4" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q5. 高度の知識や技能が必要な仕事だ</p>
                                <div class="options">
                                    <label><input type="radio" name="q5" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q5" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q5" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q5" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q6. 仕事で身体を使うことが多く、負担に感じる</p>
                                <div class="options">
                                    <label><input type="radio" name="q6" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q6" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q6" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q6" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q7. 自分の意思で仕事のやり方や手順が決められる</p>
                                <div class="options">
                                    <label><input type="radio" name="q7" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q7" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q7" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q7" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q8. 自分の仕事のペースが自分で決められる</p>
                                <div class="options">
                                    <label><input type="radio" name="q8" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q8" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q8" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q8" value="4">ちがう</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: 領域I - 仕事のストレス要因 (2/2) - Q9-Q17 -->
                    <div class="form-step" id="step-2">
                        <div class="question-section">
                            <h3>ステップ2/8: 領域I - 仕事のストレス要因 (2/2)</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q9. 職場の意見が通りやすい</p>
                                <div class="options">
                                    <label><input type="radio" name="q9" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q9" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q9" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q9" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q10. 職場の対人関係は良好だ</p>
                                <div class="options">
                                    <label><input type="radio" name="q10" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q10" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q10" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q10" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q11. 職場で孤立している</p>
                                <div class="options">
                                    <label><input type="radio" name="q11" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q11" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q11" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q11" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q12. 職場で嫌がらせやいじめを受けている</p>
                                <div class="options">
                                    <label><input type="radio" name="q12" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q12" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q12" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q12" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q13. 職場でセクハラを受けている</p>
                                <div class="options">
                                    <label><input type="radio" name="q13" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q13" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q13" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q13" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q14. 職場でパワハラを受けている</p>
                                <div class="options">
                                    <label><input type="radio" name="q14" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q14" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q14" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q14" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q15. 職場の物理的環境（騒音、温度、照明など）は快適だ</p>
                                <div class="options">
                                    <label><input type="radio" name="q15" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q15" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q15" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q15" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q16. 私は、職場で板ばさみになることがある</p>
                                <div class="options">
                                    <label><input type="radio" name="q16" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q16" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q16" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q16" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q17. 私は、自分の仕事の範囲や責任がはっきりしない</p>
                                <div class="options">
                                    <label><input type="radio" name="q17" value="4" required>そうだ</label>
                                    <label><input type="radio" name="q17" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q17" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q17" value="1">ちがう</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: 領域II - 心身のストレス反応 (1/4) - Q18-Q24 -->
                    <div class="form-step" id="step-3">
                        <div class="question-section">
                            <h3>ステップ3/8: 領域II - 心身のストレス反応 (1/4)</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q18. 活気がなく、気分が沈むことがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q18" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q18" value="3">週に数回</label>
                                    <label><input type="radio" name="q18" value="2">月に数回</label>
                                    <label><input type="radio" name="q18" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q19. 不安を感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q19" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q19" value="3">週に数回</label>
                                    <label><input type="radio" name="q19" value="2">月に数回</label>
                                    <label><input type="radio" name="q19" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q20. イライラすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q20" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q20" value="3">週に数回</label>
                                    <label><input type="radio" name="q20" value="2">月に数回</label>
                                    <label><input type="radio" name="q20" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q21. ゆううつな気分になることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q21" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q21" value="3">週に数回</label>
                                    <label><input type="radio" name="q21" value="2">月に数回</label>
                                    <label><input type="radio" name="q21" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q22. 何をするのも面倒だと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q22" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q22" value="3">週に数回</label>
                                    <label><input type="radio" name="q22" value="2">月に数回</label>
                                    <label><input type="radio" name="q22" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q23. 集中できないことがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q23" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q23" value="3">週に数回</label>
                                    <label><input type="radio" name="q23" value="2">月に数回</label>
                                    <label><input type="radio" name="q23" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q24. 気が散りやすいことがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q24" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q24" value="3">週に数回</label>
                                    <label><input type="radio" name="q24" value="2">月に数回</label>
                                    <label><input type="radio" name="q24" value="1">ほとんどない</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: 領域II - 心身のストレス反応 (2/4) - Q25-Q31 -->
                    <div class="form-step" id="step-4">
                        <div class="question-section">
                            <h3>ステップ4/8: 領域II - 心身のストレス反応 (2/4)</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q25. 頭痛がすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q25" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q25" value="3">週に数回</label>
                                    <label><input type="radio" name="q25" value="2">月に数回</label>
                                    <label><input type="radio" name="q25" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q26. 肩こりがひどいと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q26" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q26" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q26" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q26" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q27. 腰痛がすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q27" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q27" value="3">週に数回</label>
                                    <label><input type="radio" name="q27" value="2">月に数回</label>
                                    <label><input type="radio" name="q27" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q28. 胃の調子が悪いと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q28" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q28" value="3">週に数回</label>
                                    <label><input type="radio" name="q28" value="2">月に数回</label>
                                    <label><input type="radio" name="q28" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q29. 寝つきが悪い、または眠りが浅いと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q29" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q29" value="3">週に数回</label>
                                    <label><input type="radio" name="q29" value="2">月に数回</label>
                                    <label><input type="radio" name="q29" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q30. 疲れて仕事に行くのがつらいと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q30" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q30" value="3">週に数回</label>
                                    <label><input type="radio" name="q30" value="2">月に数回</label>
                                    <label><input type="radio" name="q30" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q31. 食欲がないと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q31" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q31" value="3">週に数回</label>
                                    <label><input type="radio" name="q31" value="2">月に数回</label>
                                    <label><input type="radio" name="q31" value="1">ほとんどない</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: 領域II - 心身のストレス反応 (3/4) - Q32-Q38 -->
                    <div class="form-step" id="step-5">
                        <div class="question-section">
                            <h3>ステップ5/8: 領域II - 心身のストレス反応 (3/4)</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q32. めまいがすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q32" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q32" value="3">週に数回</label>
                                    <label><input type="radio" name="q32" value="2">月に数回</label>
                                    <label><input type="radio" name="q32" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q33. 動悸や息切れがすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q33" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q33" value="3">週に数回</label>
                                    <label><input type="radio" name="q33" value="2">月に数回</label>
                                    <label><input type="radio" name="q33" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q34. 汗をかくことが多くなった</p>
                                <div class="options">
                                    <label><input type="radio" name="q34" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q34" value="3">週に数回</label>
                                    <label><input type="radio" name="q34" value="2">月に数回</label>
                                    <label><input type="radio" name="q34" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q35. どきどきすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q35" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q35" value="3">週に数回</label>
                                    <label><input type="radio" name="q35" value="2">月に数回</label>
                                    <label><input type="radio" name="q35" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q36. 息苦しさを感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q36" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q36" value="3">週に数回</label>
                                    <label><input type="radio" name="q36" value="2">月に数回</label>
                                    <label><input type="radio" name="q36" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q37. 手足が冷たいと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q37" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q37" value="3">週に数回</label>
                                    <label><input type="radio" name="q37" value="2">月に数回</label>
                                    <label><input type="radio" name="q37" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q38. 身体がだるいと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q38" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q38" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q38" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q38" value="1">ちがう</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: 領域II - 心身のストレス反応 (4/4) - Q39-Q46 -->
                    <div class="form-step" id="step-6">
                        <div class="question-section">
                            <h3>ステップ6/8: 領域II - 心身のストレス反応 (4/4)</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q39. 眠りが浅い、または途中で目が覚めることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q39" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q39" value="3">週に数回</label>
                                    <label><input type="radio" name="q39" value="2">月に数回</label>
                                    <label><input type="radio" name="q39" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q40. 朝、なかなか起きられないことがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q40" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q40" value="3">週に数回</label>
                                    <label><input type="radio" name="q40" value="2">月に数回</label>
                                    <label><input type="radio" name="q40" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q41. 寝ても疲れがとれないと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q41" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q41" value="3">週に数回</label>
                                    <label><input type="radio" name="q41" value="2">月に数回</label>
                                    <label><input type="radio" name="q41" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q42. 身体のどこかに痛みを感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q42" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q42" value="3">週に数回</label>
                                    <label><input type="radio" name="q42" value="2">月に数回</label>
                                    <label><input type="radio" name="q42" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q43. 身体が重いと感じることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q43" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q43" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q43" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q43" value="1">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q44. 吐き気がすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q44" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q44" value="3">週に数回</label>
                                    <label><input type="radio" name="q44" value="2">月に数回</label>
                                    <label><input type="radio" name="q44" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q45. 便秘や下痢をすることがあった</p>
                                <div class="options">
                                    <label><input type="radio" name="q45" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q45" value="3">週に数回</label>
                                    <label><input type="radio" name="q45" value="2">月に数回</label>
                                    <label><input type="radio" name="q45" value="1">ほとんどない</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q46. のどが渇くことが多くなった</p>
                                <div class="options">
                                    <label><input type="radio" name="q46" value="4" required>ほとんど毎日</label>
                                    <label><input type="radio" name="q46" value="3">まあそうだ</label>
                                    <label><input type="radio" name="q46" value="2">どちらでもない</label>
                                    <label><input type="radio" name="q46" value="1">ちがう</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 7: 領域III - 周囲のサポート (9項目) - Q47-Q55 -->
                    <div class="form-step" id="step-7">
                        <div class="question-section">
                            <h3>ステップ7/8: 領域III - 周囲のサポート</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q47. 上司はあなたの仕事や個人的な問題を理解し、サポートしてくれた</p>
                                <div class="options">
                                    <label><input type="radio" name="q47" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q47" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q47" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q47" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q48. 上司はあなたの意見を聞いてくれた</p>
                                <div class="options">
                                    <label><input type="radio" name="q48" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q48" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q48" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q48" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q49. 同僚はあなたの仕事や個人的な問題を理解し、サポートしてくれた</p>
                                <div class="options">
                                    <label><input type="radio" name="q49" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q49" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q49" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q49" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q50. 同僚と気軽に話すことができた</p>
                                <div class="options">
                                    <label><input type="radio" name="q50" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q50" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q50" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q50" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q51. 家族や友人など、職場以外の人々はあなたの仕事や個人的な問題を理解し、サポートしてくれた</p>
                                <div class="options">
                                    <label><input type="radio" name="q51" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q51" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q51" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q51" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q52. 職場に相談できる相手がいた</p>
                                <div class="options">
                                    <label><input type="radio" name="q52" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q52" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q52" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q52" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q53. 職場以外に相談できる相手がいた</p>
                                <div class="options">
                                    <label><input type="radio" name="q53" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q53" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q53" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q53" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q54. 職場で自分の意見を自由に言える雰囲気がある</p>
                                <div class="options">
                                    <label><input type="radio" name="q54" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q54" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q54" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q54" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q55. 職場で困った時に助けてくれる人がいる</p>
                                <div class="options">
                                    <label><input type="radio" name="q55" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q55" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q55" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q55" value="4">ちがう</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 8: 領域IV - 満足度・活気 (2項目) - Q56-Q57 -->
                    <div class="form-step" id="step-8">
                        <div class="question-section">
                            <h3>ステップ8/8: 満足度・活気</h3>
                            <p class="mb-4 text-gray-600">最近1ヶ月間のあなたの状態について、最もあてはまるものを選んでください。</p>

                            <div class="mb-4">
                                <p class="question-text">Q56. 仕事に満足している</p>
                                <div class="options">
                                    <label><input type="radio" name="q56" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q56" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q56" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q56" value="4">ちがう</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="question-text">Q57. 生活に満足している</p>
                                <div class="options">
                                    <label><input type="radio" name="q57" value="1" required>そうだ</label>
                                    <label><input type="radio" name="q57" value="2">まあそうだ</label>
                                    <label><input type="radio" name="q57" value="3">どちらでもない</label>
                                    <label><input type="radio" name="q57" value="4">ちがう</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" id="prevBtn" class="prev-button" disabled>戻る</button>
                        <button type="button" id="nextBtn" class="next-button">次へ</button>
                        <button type="submit" id="submitBtn" class="submit-button hidden">結果を見る</button>
                    </div>
                </form>

                <div id="resultSection" class="result-section hidden">
                    <h2>ストレスチェック結果</h2>
                    <div class="result-score" id="totalScore"></div>
                    <p class="result-message" id="resultMessage"></p>

                    <!-- Overall Radar Chart -->
                    <div class="chart-container">
                        <h3>全体バランス</h3>
                        <canvas id="stressRadarChartOverall"></canvas>
                    </div>

                    <!-- Detailed Radar Charts -->
                    <div class="chart-container">
                        <h3>仕事のストレス要因 (領域I)</h3>
                        <canvas id="stressRadarChartSectionI"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>心身のストレス反応 (領域II)</h3>
                        <canvas id="stressRadarChartSectionII"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>サポートと満足度 (領域III & IV)</h3>
                        <canvas id="stressRadarChartCombinedSectionIIIIV"></canvas>
                    </div>

                    <!-- Scatter Plots -->
                    <div class="scatter-plot-container">
                        <h3>量―コントロール判定図</h3>
                        <canvas id="quantityControlScatterChart"></canvas>
                        <div id="quantityControlQuadrantLabel1" class="quadrant-label">高ストレス（ハイストレイン）</div>
                        <div id="quantityControlQuadrantLabel2" class="quadrant-label">受動的</div>
                        <div id="quantityControlQuadrantLabel3" class="quadrant-label">低ストレス</div>
                        <div id="quantityControlQuadrantLabel4" class="quadrant-label">能動的</div>
                    </div>

                    <div class="scatter-plot-container">
                        <h3>職場の支援判定図</h3>
                        <canvas id="workSupportScatterChart"></canvas>
                        <div id="supportQuadrantLabel1" class="quadrant-label">高サポート</div>
                        <div id="supportQuadrantLabel2" class="quadrant-label">同僚のみサポート</div>
                        <div id="supportQuadrantLabel3" class="quadrant-label">低サポート</div>
                        <div id="supportQuadrantLabel4" class="quadrant-label">上司のみサポート</div>
                    </div>


                    <div class="result-details">
                        <h3>各領域のスコア</h3>
                        <p><strong>領域I (仕事のストレス要因):</strong> <span id="scoreSectionI"></span>点</p>
                        <p><strong>領域II (心身のストレス反応):</strong> <span id="scoreSectionII"></span>点</p>
                        <p><strong>領域III (周囲のサポート):</strong> <span id="scoreSectionIII"></span>点</p>
                        <p><strong>満足度・活気:</strong> <span id="scoreSectionIV"></span>点</p>
                    </div>

                    <!-- Gemini API Advice Section -->
                    <div class="mt-8 pt-8 border-t border-gray-200 text-center">
                        <button id="getAdviceBtn" class="submit-button flex items-center justify-center gap-2">
                            ✨ ストレス対策アドバイスをもらう ✨
                        </button>
                        <div id="adviceLoading" class="hidden mt-4 text-blue-600">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="mt-2">アドバイス生成中...</p>
                        </div>
                        <div id="adviceDisplay" class="mt-6 p-5 bg-blue-50 rounded-lg text-left text-gray-700 hidden">
                            <h3 class="font-semibold text-blue-800 mb-3">パーソナルアドバイス</h3>
                            <p id="adviceText" class="whitespace-pre-wrap"></p>
                        </div>
                    </div>

                    <p class="footer-note mt-4">
                        この結果はあくまで参考です。ご自身の健康状態に不安がある場合は、専門家にご相談ください。<br>
                        正確な評価には、厚生労働省の公式なストレスチェック実施マニュアルを参照してください。
                    </p>
                </div>
            </div>
        </div> <!-- End of app-wrapper -->
    </div> <!-- End of stress-check-outer-wrapper -->

    <script>
        // Custom message box function (replaces alert())
        function displayCustomMessage(message) {
            const existingMessageBox = document.getElementById('customMessageBox');
            if (existingMessageBox) {
                existingMessageBox.remove();
            }

            const messageBox = document.createElement('div');
            messageBox.id = 'customMessageBox';
            messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50';
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold mb-4">${message}</p>
                    <button id="closeMessageBox" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">閉じる</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('closeMessageBox').addEventListener('click', function() {
                messageBox.remove();
            });
        }

        let currentStep = 0;
        const formSteps = document.querySelectorAll('.form-step');
        const progressBar = document.getElementById('progressBar');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const totalSteps = formSteps.length;

        // Define all 57 questions (q1 to q57)
        const allQuestions = [];
        for (let i = 1; i <= 57; i++) {
            allQuestions.push(`q${i}`);
        }

        // Define question types for raw score conversion (A: higher value = higher stress, B: higher value = lower stress)
        // Based on Table 1 from the provided text immersive.
        const mhlwQuestionTypeMap = {
            // 領域I: 仕事のストレス要因 (17項目)
            // タイプA項目 (そうだ=4, ちがう=1)
            q1: 'A', q2: 'A', q3: 'A', q4: 'A', q5: 'A', q6: 'A',
            q7: 'A', // Q7: 自覚的な身体的負担度 (Type A)
            q11: 'A', q12: 'A', q13: 'A',
            q15: 'A', // Q15: 職場環境によるストレス (Type A)

            // タイプB項目 (そうだ=1, ちがう=4)
            q8: 'B', q9: 'B', q10: 'B', // 仕事のコントロール度 (Q8-10)
            q14: 'B', // 職場の対人関係でのストレス (Q14)
            q16: 'B', // 役割葛藤 (Q16)
            q17: 'B', // 役割曖昧さ (Q17)

            // 領域II: 心身のストレス反応 (29項目) - All Type A
            q18: 'A', q19: 'A', q20: 'A', q21: 'A', q22: 'A', q23: 'A', q24: 'A', q25: 'A', q26: 'A', q27: 'A', q28: 'A', q29: 'A',
            q30: 'A', q31: 'A', q32: 'A', q33: 'A', q34: 'A', q35: 'A', q36: 'A', q37: 'A', q38: 'A', q39: 'A', q40: 'A', q41: 'A', q42: 'A', q43: 'A', q44: 'A', q45: 'A', q46: 'A',

            // 領域III: 周囲のサポート (9項目) - All Type B
            q47: 'B', q48: 'B', q49: 'B', q50: 'B', q51: 'B', q52: 'B', q53: 'B', q54: 'B', q55: 'B',

            // 領域IV: 満足度・活気 (2項目) - All Type B
            q56: 'B', q57: 'B'
        };


        // Define step-to-question mapping for multi-step form
        const stepQuestionsMap = {
            0: ['q1', 'q2', 'q3', 'q4', 'q5', 'q6', 'q7', 'q8'], // Step 1: 領域I (1/2) - Q1-Q8
            1: ['q9', 'q10', 'q11', 'q12', 'q13', 'q14', 'q15', 'q16', 'q17'], // Step 2: 領域I (2/2) - Q9-Q17
            2: ['q18', 'q19', 'q20', 'q21', 'q22', 'q23', 'q24'], // Step 3: 領域II (1/4) - Q18-Q24
            3: ['q25', 'q26', 'q27', 'q28', 'q29', 'q30', 'q31'], // Step 4: 領域II (2/4) - Q25-Q31
            4: ['q32', 'q33', 'q34', 'q35', 'q36', 'q37', 'q38'], // Step 5: 領域II (3/4) - Q32-Q38
            5: ['q39', 'q40', 'q41', 'q42', 'q43', 'q44', 'q45', 'q46'], // Step 6: 領域II (4/4) - Q39-Q46
            6: ['q47', 'q48', 'q49', 'q50', 'q51', 'q52', 'q53', 'q54', 'q55'], // Step 7: 領域III - Q47-Q55
            7: ['q56', 'q57'] // Step 8: 領域IV - Q56-Q57
        };

        function showStep(stepIndex) {
            formSteps.forEach((step, index) => {
                if (index === stepIndex) {
                    step.classList.remove('hidden');
                    setTimeout(() => {
                        step.classList.add('active');
                    }, 10); // Small delay for transition
                } else {
                    step.classList.remove('active');
                    step.classList.add('hidden');
                }
            });
            updateProgressBar();
            updateNavigationButtons();
        }

        function updateProgressBar() {
            const progress = ((currentStep + 1) / totalSteps) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateNavigationButtons() {
            prevBtn.disabled = currentStep === 0;
            nextBtn.classList.toggle('hidden', currentStep === totalSteps - 1);
            submitBtn.classList.toggle('hidden', currentStep !== totalSteps - 1);
        }

        function validateCurrentStep() {
            const currentStepQuestions = stepQuestionsMap[currentStep];
            let allAnswered = true;
            currentStepQuestions.forEach(qName => {
                const radios = document.getElementsByName(qName);
                let answered = false;
                for (const radio of radios) {
                    if (radio.checked) {
                        answered = true;
                        break;
                    }
                }
                if (!answered) {
                    allAnswered = false;
                }
            });
            return allAnswered;
        }

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (!validateCurrentStep()) {
                displayCustomMessage('現在のページのすべての質問に回答してください。');
                return;
            }
            if (currentStep < totalSteps - 1) {
                currentStep++;
                showStep(currentStep);
            }
        });

        // Function to get the MHLW raw score (1-4) based on question type (Type A or Type B)
        // Type A: Higher HTML value (e.g., 4 for "そうだ") means higher raw score (4)
        // Type B: Higher HTML value (e.g., 4 for "ちがう") means lower raw score (1), so reverse mapping
        function getMHLWRawScore(qName, selectedValue) {
            const value = parseInt(selectedValue); // User's selected value (1-4 from HTML)
            if (mhlwQuestionTypeMap[qName] === 'A') {
                return value; // Direct mapping
            } else { // 'B' type question
                return 5 - value; // Reverse mapping (1->4, 2->3, 3->2, 4->1)
            }
        }

        // Global variables to store scores for LLM advice
        let globalScaleScores = {};
        let globalIsHighStressor = false;
        let globalHighStressorReason = [];

        document.getElementById('stressCheckForm').addEventListener('submit', function(event) {
            event.preventDefault();

            if (!validateCurrentStep()) {
                displayCustomMessage('現在のページのすべての質問に回答してください。');
                return;
            }

            const form = event.target;
            const rawScores = {}; // Stores { 'q1': MHLW_raw_score, 'q2': MHLW_raw_score, ... }

            // Populate rawScores by converting user's answers to MHLW raw scores (1-4)
            allQuestions.forEach(qName => {
                const selectedOption = form.elements[qName].value;
                if (selectedOption) {
                    rawScores[qName] = getMHLWRawScore(qName, selectedOption);
                }
            });

            // Calculate Scale Scores based on standard 57-item survey.
            // These scores will be interpreted as: higher score = higher stress/less support/less satisfaction.
            // For radar chart display, support/satisfaction scales will be reversed to show "higher = less support/satisfaction"
            const scaleScores = {};

            // 領域I: 仕事のストレス要因 (17項目) - Higher score = Higher stress
            scaleScores.workload_quantity = rawScores.q1 + rawScores.q2 + rawScores.q3; // 量的負担 (3項目)
            scaleScores.workload_quality = rawScores.q4 + rawScores.q5; // 質的負担 (2項目)
            scaleScores.physical_burden = rawScores.q6; // 身体的負担度 (1項目)
            scaleScores.control = rawScores.q7 + rawScores.q8 + rawScores.q9; // 仕事のコントロール度 (3項目) - Type B, so higher raw score means less control
            scaleScores.interpersonal_relations = rawScores.q10 + rawScores.q11 + rawScores.q12 + rawScores.q13 + rawScores.q14; // 対人関係 (5項目) - Q10 is Type B, others are Type A. Sum of raw scores will be higher for more stress.
            scaleScores.work_environment = rawScores.q15; // 職場環境 (1項目) - Type B, so higher rawScore means worse environment (more stress)
            scaleScores.role_conflict = rawScores.q16; // 役割葛藤 (1項目) - Type B, so higher rawScore means more conflict (more stress)
            scaleScores.role_ambiguity = rawScores.q17; // 役割曖昧さ (1項目) - Type B, so higher rawScore means more ambiguity (more stress)

            // 領域II: 心身のストレス反応 (29項目) - Higher score = Higher stress
            scaleScores.vitality = rawScores.q18 + rawScores.q19 + rawScores.q20; // 活気 (3項目) - Type A
            scaleScores.irritability = rawScores.q21 + rawScores.q22 + rawScores.q23; // イライラ (3項目) - Type A
            scaleScores.anxiety = rawScores.q24 + rawScores.q25 + rawScores.q26 + rawScores.q27 + rawScores.q28 + rawScores.q29; // 不安 (6項目) - Type A
            scaleScores.depression = rawScores.q31 + rawScores.q32 + rawScores.q33 + rawScores.q34 + rawScores.q35; // 抑うつ (5項目) - Type A (Q30 moved)
            scaleScores.fatigue = rawScores.q30 + rawScores.q41; // 疲労感 (2項目) - Type A (Q30, Q41 extracted)
            scaleScores.physical_complaints = rawScores.q36 + rawScores.q37 + rawScores.q38 + rawScores.q39 + rawScores.q40 + rawScores.q42 + rawScores.q43 + rawScores.q44 + rawScores.q45 + rawScores.q46; // 身体愁訴 (10項目) - Type A (Q41 moved)

            // 領域III: 周囲のサポート (9項目) - Higher score = More support
            scaleScores.supervisor_support = rawScores.q47 + rawScores.q48 + rawScores.q49; // 上司からのサポート (3項目) - Type B
            scaleScores.colleague_support = rawScores.q50 + rawScores.q51 + rawScores.q52; // 同僚からのサポート (3項目) - Type B
            scaleScores.family_friend_support = rawScores.q53 + rawScores.q54 + rawScores.q55; // 家族・友人からのサポート (3項目) - Type B

            // 領域IV: 満足度・活気 (2項目) - Higher score = More satisfaction
            scaleScores.job_satisfaction = rawScores.q56; // 仕事の満足度 (1項目) - Type B
            scaleScores.life_satisfaction = rawScores.q57; // 生活の満足度 (1項目) - Type B

            // Store scaleScores globally for LLM advice
            globalScaleScores = scaleScores;

            // Calculate total scores for each main group (sum of relevant scale scores)
            const totalScoreSectionI = scaleScores.workload_quantity + scaleScores.workload_quality +
                                       scaleScores.physical_burden + scaleScores.control +
                                       scaleScores.interpersonal_relations + scaleScores.work_environment +
                                       scaleScores.role_conflict + scaleScores.role_ambiguity;

            const totalScoreSectionII = scaleScores.vitality + scaleScores.irritability +
                                        scaleScores.anxiety + scaleScores.depression +
                                        scaleScores.fatigue + scaleScores.physical_complaints;

            const totalScoreSectionIII = scaleScores.supervisor_support + scaleScores.colleague_support +
                                         scaleScores.family_friend_support;

            const totalScoreSectionIV = scaleScores.job_satisfaction + scaleScores.life_satisfaction;

            // Sum of raw scores (1-4 points) for each group for high stressor determination
            // This uses the raw values (1-4) as per the user's provided Table 3.
            // Note: The raw score sums for high stressor determination are based on the original raw scores, not the transformed scale scores.
            let groupA_raw_sum_for_check = 0;
            for (let i = 1; i <= 17; i++) { groupA_raw_sum_for_check += parseInt(form.elements[`q${i}`].value); }
            let groupB_raw_sum_for_check = 0;
            for (let i = 18; i <= 46; i++) { groupB_raw_sum_for_check += parseInt(form.elements[`q${i}`].value); }
            let groupC_raw_sum_for_check = 0;
            for (let i = 47; i <= 55; i++) { groupC_raw_sum_for_check += parseInt(form.elements[`q${i}`].value); }


            // High Stressor Determination (Table 3 from user's provided document)
            let isHighStressor = false;
            let highStressorReason = [];

            // Condition 1: 「心身のストレス反応」（B群）の評価点の合計が12点以下である者。
            // (This condition implies lower raw score sum in B group means high stress, as per the user's document.)
            if (groupB_raw_sum_for_check <= 12) {
                isHighStressor = true;
                highStressorReason.push('心身のストレス反応（B群）の評価点合計が12点以下です。');
            }

            // Condition 2: 「仕事のストレス要因」（A群）と「周囲のサポート」（C群）の評価点の合計が26点以下であって、
            // かつ、「心身のストレス反応」（B群）の評価点の合計が17点以下である者。
            if ((groupA_raw_sum_for_check + groupC_raw_sum_for_check) <= 26 && groupB_raw_sum_for_check <= 17) {
                isHighStressor = true;
                highStressorReason.push('仕事のストレス要因（A群）と周囲のサポート（C群）の評価点合計が26点以下、かつ心身のストレス反応（B群）の評価点合計が17点以下です。');
            }

            // Store high stressor determination globally for LLM advice
            globalIsHighStressor = isHighStressor;
            globalHighStressorReason = highStressorReason;

            // Overall Total Score (sum of the main group scale scores for general indication)
            const overall_total_score = totalScoreSectionI + totalScoreSectionII + totalScoreSectionIII + totalScoreSectionIV;

            // Generate result message based on high stressor determination
            let finalMessage = '';
            if (isHighStressor) {
                finalMessage = `**高ストレス者と判定されました。専門家への相談を強くお勧めします。**<br>理由: ${highStressorReason.join(' および ')}`;
            } else {
                finalMessage = '現在のストレスレベルは高ストレス者には該当しません。この状態を維持できるよう、引き続き心身の健康に気を配りましょう。';
            }

            // Update and display result section elements
            const resultSection = document.getElementById('resultSection');
            const totalScoreDisplay = document.getElementById('totalScore');
            const resultMessage = document.getElementById('resultMessage');
            const scoreSectionIDisplay = document.getElementById('scoreSectionI');
            const scoreSectionIIDisplay = document.getElementById('scoreSectionII');
            const scoreSectionIIIDisplay = document.getElementById('scoreSectionIII');
            const scoreSectionIVDisplay = document.getElementById('scoreSectionIV');

            totalScoreDisplay.textContent = `合計スコア: ${overall_total_score}点`;
            resultMessage.innerHTML = finalMessage; // Use innerHTML for <br> tags
            scoreSectionIDisplay.textContent = totalScoreSectionI;
            scoreSectionIIDisplay.textContent = totalScoreSectionII;
            scoreSectionIIIDisplay.textContent = totalScoreSectionIII;
            scoreSectionIVDisplay.textContent = totalScoreSectionIV;

            // --- Radar Charts Drawing ---

            // Helper function to create a radar chart
            function createRadarChart(canvasId, labels, data, title, maxScale) {
                console.log(`Attempting to create chart: ${canvasId}`);
                console.log('Labels:', labels);
                console.log('Data:', data);
                console.log('Max Scale:', maxScale);
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (!ctx) {
                    console.error(`Canvas context not found for ID: ${canvasId}`);
                    return; // Exit if context is not found
                }
                if (window[canvasId + 'Instance']) {
                    window[canvasId + 'Instance'].destroy();
                    console.log(`Destroyed existing chart for ${canvasId}`);
                }
                window[canvasId + 'Instance'] = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'あなたのスコア',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.4)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: title,
                                font: { size: 16, weight: 'bold' },
                                color: '#2d3748'
                            }
                        },
                        scales: {
                            r: {
                                angleLines: { color: '#e2e8f0' },
                                grid: { color: '#e2e8f0' },
                                pointLabels: { font: { size: 14, weight: 'bold' }, color: '#4a5568' },
                                suggestedMin: 0,
                                ticks: { display: false },
                                max: maxScale
                            }
                        }
                    }
                });
                console.log(`Successfully created chart for ${canvasId}`);
            }

            // Overall Radar Chart (Main 4 Groups)
            const radarLabelsOverall = ['仕事のストレス要因', '心身のストレス反応', '周囲のサポート', '満足度・活気'];
            // For overall radar, reverse support and satisfaction for consistent "higher = higher stress/less support/less satisfaction"
            // Max possible scale scores for each section (when stress is highest for stressors/reactions, or lowest for support/satisfaction)
            const maxScoreSectionI_sum = (4*3 + 4*2 + 4*1) + (4*3) + (4*5) + (4*1) + (4*1) + (4*1); // 量的12+質的8+身体4 + コントロール12 + 対人20 + 職場4 + 役割葛藤4 + 役割曖昧さ4 = 68
            const maxScoreSectionII_sum = (4*3) + (4*3) + (4*6) + (4*5) + (4*2) + (4*10); // 活気12+イライラ12+不安24+抑うつ20+疲労感8+身体愁訴40 = 116
            const maxScoreSectionIII_sum = (4*3) + (4*3) + (4*3); // 上司12+同僚12+家族12 = 36
            const maxScoreSectionIV_sum = (4*1) + (4*1); // 仕事4+生活4 = 8

            const radarDataOverall = [
                totalScoreSectionI, // Higher = higher stress
                totalScoreSectionII, // Higher = higher stress
                maxScoreSectionIII_sum - totalScoreSectionIII, // Reversed: Higher = less support
                maxScoreSectionIV_sum - totalScoreSectionIV // Reversed: Higher = less satisfaction
            ];
            const radarOverallMaxScale = Math.max(maxScoreSectionI_sum, maxScoreSectionII_sum,
                                                 (maxScoreSectionIII_sum - (1*9)), // Max transformed support = 36 - 9 = 27 (when support is highest)
                                                 (maxScoreSectionIV_sum - (1*2))); // Max transformed satisfaction = 8 - 2 = 6 (when satisfaction is highest)

            createRadarChart('stressRadarChartOverall', radarLabelsOverall, radarDataOverall, '各領域のバランス', radarOverallMaxScale);

            // Detailed Radar Chart: 領域I - 仕事のストレス要因
            const labelsSectionI = ['量的負担', '質的負担', '身体的負担', 'コントロール', '対人関係', '職場環境', '役割葛藤', '役割曖昧さ'];
            const dataSectionI = [
                scaleScores.workload_quantity, scaleScores.workload_quality, scaleScores.physical_burden,
                scaleScores.control, scaleScores.interpersonal_relations, scaleScores.work_environment,
                scaleScores.role_conflict, scaleScores.role_ambiguity
            ];
            // Max values for each sub-scale in Section I (all are now higher=higher stress)
            const maxScaleI_sub = Math.max(12, 8, 4, 12, 20, 4, 4, 4);
            createRadarChart('stressRadarChartSectionI', labelsSectionI, dataSectionI, '仕事のストレス要因', maxScaleI_sub);

            // Detailed Radar Chart: 領域II - 心身のストレス反応 (6 points including 疲労感)
            const labelsSectionII = ['活気', 'イライラ', '不安', '抑うつ', '疲労感', '身体愁訴'];
            const dataSectionII = [
                scaleScores.vitality, scaleScores.irritability, scaleScores.anxiety,
                scaleScores.depression, scaleScores.fatigue, scaleScores.physical_complaints
            ];
            // Max values for each sub-scale in Section II (all are now higher=higher stress)
            const maxScaleII_sub = Math.max(12, 12, 24, 20, 8, 40);
            createRadarChart('stressRadarChartSectionII', labelsSectionII, dataSectionII, '心身のストレス反応', maxScaleII_sub);

            // Combined Radar Chart: 周囲のサポート（領域Ⅲ）と満足・活気（領域Ⅳ） (4 points)
            const labelsCombinedIIIIV = ['上司サポート', '同僚サポート', '家族・友人サポート', '全体満足度'];
            // Max possible scores for each sub-scale in III & IV (original, higher=more support/satisfaction)
            const maxSupSup = 12; // 3 items * 4 points
            const maxColSup = 12; // 3 items * 4 points
            const maxFamSup = 12; // 3 items * 4 points
            const maxJobSat = 4; // 1 item * 4 points
            const maxLifeSat = 4; // 1 item * 4 points

            const dataCombinedIIIIV = [
                maxSupSup - scaleScores.supervisor_support, // Reverse for radar: higher value = less support
                maxColSup - scaleScores.colleague_support, // Reverse for radar: higher value = less support
                maxFamSup - scaleScores.family_friend_support, // Reverse for radar: higher value = less support
                (maxJobSat - scaleScores.job_satisfaction) + (maxLifeSat - scaleScores.life_satisfaction) // Combined satisfaction, reversed
            ];
            // Max scale for combined chart axes (transformed values)
            const maxCombinedIIIIV_sub = Math.max(
                maxSupSup - (3*1), // Max transformed supervisor support (12-3=9)
                maxColSup - (3*1), // Max transformed colleague support (12-3=9)
                maxFamSup - (3*1), // Max transformed family support (12-3=9)
                (maxJobSat - 1) + (maxLifeSat - 1) // Max transformed combined satisfaction (3+3=6)
            );
            createRadarChart('stressRadarChartCombinedSectionIIIIV', labelsCombinedIIIIV, dataCombinedIIIIV, 'サポートと満足度', maxCombinedIIIIV_sub);

            // --- Scatter Plots Drawing ---

            // Quantity-Control Scatter Plot
            const quantityControlX = scaleScores.workload_quantity; // 量的負担
            const quantityControlY = scaleScores.control; // 仕事のコントロール度

            // Max values for Quantity-Control Scatter Plot axes
            const maxQuantity = 12; // Max possible score for 量的負担 (3 items * 4 points)
            const maxControl = 12; // Max possible score for コントロール度 (3 items * 4 points)

            const quantityControlCtx = document.getElementById('quantityControlScatterChart').getContext('2d');
            if (window.quantityControlScatterChartInstance) {
                window.quantityControlScatterChartInstance.destroy();
            }
            window.quantityControlScatterChartInstance = new Chart(quantityControlCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'あなたの位置',
                        data: [{ x: quantityControlX, y: quantityControlY }],
                        backgroundColor: 'rgba(59, 130, 246, 1)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '量―コントロール判定図',
                            font: { size: 16, weight: 'bold' },
                            color: '#2d3748'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `量的負担: ${context.parsed.x}点, コントロール度: ${context.parsed.y}点`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '仕事の量的負担 (高いほどストレスが高い)',
                                font: { size: 14, weight: 'bold' },
                                color: '#4a5568'
                            },
                            min: 0,
                            max: maxQuantity,
                            ticks: { display: false },
                            grid: {
                                drawOnChartArea: true,
                                color: function(context) {
                                    return context.tick.value === (maxQuantity / 2) ? '#ef4444' : '#e2e8f0'; // Red for center line
                                },
                                lineWidth: function(context) {
                                    return context.tick.value === (maxQuantity / 2) ? 2 : 1;
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: '仕事のコントロール度 (高いほどストレスが低い)',
                                font: { size: 14, weight: 'bold' },
                                color: '#4a5568'
                            },
                            min: 0,
                            max: maxControl,
                            ticks: { display: false },
                            grid: {
                                drawOnChartArea: true,
                                color: function(context) {
                                    return context.tick.value === (maxControl / 2) ? '#ef4444' : '#e2e8f0'; // Red for center line
                                },
                                lineWidth: function(context) {
                                    return context.tick.value === (maxControl / 2) ? 2 : 1;
                                }
                            }
                        }
                    }
                }
            });

            // Work Support Scatter Plot
            const workSupportX = scaleScores.supervisor_support; // 上司からのサポート
            const workSupportY = scaleScores.colleague_support; // 同僚からのサポート

            // Max values for Work Support Scatter Plot axes
            const maxSupervisorSupport = 12; // 3 items * 4 points
            const maxColleagueSupport = 12; // 3 items * 4 points

            const workSupportCtx = document.getElementById('workSupportScatterChart').getContext('2d');
            if (window.workSupportScatterChartInstance) {
                window.workSupportScatterChartInstance.destroy();
            }
            window.workSupportScatterChartInstance = new Chart(workSupportCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'あなたの位置',
                        data: [{ x: workSupportX, y: workSupportY }],
                        backgroundColor: 'rgba(59, 130, 246, 1)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '職場の支援判定図',
                            font: { size: 16, weight: 'bold' },
                            color: '#2d3748'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `上司サポート: ${context.parsed.x}点, 同僚サポート: ${context.parsed.y}点`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '上司からのサポート (高いほどサポートが充実)',
                                font: { size: 14, weight: 'bold' },
                                color: '#4a5568'
                            },
                            min: 0,
                            max: maxSupervisorSupport,
                            ticks: { display: false },
                            grid: {
                                drawOnChartArea: true,
                                color: function(context) {
                                    return context.tick.value === (maxSupervisorSupport / 2) ? '#ef4444' : '#e2e8f0';
                                },
                                lineWidth: function(context) {
                                    return context.tick.value === (maxSupervisorSupport / 2) ? 2 : 1;
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: '同僚からのサポート (高いほどサポートが充実)',
                                font: { size: 14, weight: 'bold' },
                                color: '#4a5568'
                            },
                            min: 0,
                            max: maxColleagueSupport,
                            ticks: { display: false },
                            grid: {
                                drawOnChartArea: true,
                                color: function(context) {
                                    return context.tick.value === (maxColleagueSupport / 2) ? '#ef4444' : '#e2e8f0';
                                },
                                lineWidth: function(context) {
                                    return context.tick.value === (maxColleagueSupport / 2) ? 2 : 1;
                                }
                            }
                        }
                    }
                }
            });


            resultSection.classList.remove('hidden'); // 結果セクションを表示
            form.classList.add('hidden'); // フォームを非表示
            progressBar.classList.add('hidden'); // プログレスバーを非表示

            // 結果セクションまでスムーズにスクロール
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // Gemini API Advice Logic
        const getAdviceBtn = document.getElementById('getAdviceBtn');
        const adviceLoading = document.getElementById('adviceLoading');
        const adviceDisplay = document.getElementById('adviceDisplay');
        const adviceText = document.getElementById('adviceText');

        getAdviceBtn.addEventListener('click', async () => {
            adviceDisplay.classList.add('hidden');
            adviceLoading.classList.remove('hidden');
            getAdviceBtn.disabled = true;

            // Gemini APIに渡すプロンプトを詳細なスケールスコアで準備
            const prompt = `あなたは厚生労働省のストレスチェックの専門家です。以下のストレスチェック結果に基づいて、ユーザーにパーソナライズされたストレス対策のアドバイスを提供してください。結果は以下の通りです：
- 仕事のストレス要因（領域I）合計: ${globalScaleScores.workload_quantity + globalScaleScores.workload_quality + globalScaleScores.physical_burden + globalScaleScores.control + globalScaleScores.interpersonal_relations + globalScaleScores.work_environment + globalScaleScores.role_conflict + globalScaleScores.role_ambiguity}点 (高ければストレスが高い)
  - 量的負担: ${globalScaleScores.workload_quantity}点
  - 質的負担: ${globalScaleScores.workload_quality}点
  - 身体的負担: ${globalScaleScores.physical_burden}点
  - コントロール: ${globalScaleScores.control}点
  - 対人関係: ${globalScaleScores.interpersonal_relations}点
  - 職場環境: ${globalScaleScores.work_environment}点
  - 役割葛藤: ${globalScaleScores.role_conflict}点
  - 役割曖昧さ: ${globalScaleScores.role_ambiguity}点

- 心身のストレス反応（領域II）合計: ${globalScaleScores.vitality + globalScaleScores.irritability + globalScaleScores.anxiety + globalScaleScores.depression + globalScaleScores.fatigue + globalScaleScores.physical_complaints}点 (高ければストレスが高い)
  - 活気: ${globalScaleScores.vitality}点
  - イライラ: ${globalScaleScores.irritability}点
  - 不安: ${globalScaleScores.anxiety}点
  - 抑うつ: ${globalScaleScores.depression}点
  - 疲労感: ${globalScaleScores.fatigue}点
  - 身体愁訴: ${globalScaleScores.physical_complaints}点

- 周囲のサポート（領域III）合計: ${globalScaleScores.supervisor_support + globalScaleScores.colleague_support + globalScaleScores.family_friend_support}点 (高ければサポートが充実している)
  - 上司からのサポート: ${globalScaleScores.supervisor_support}点
  - 同僚からのサポート: ${globalScaleScores.colleague_support}点
  - 家族・友人からのサポート: ${globalScaleScores.family_friend_support}点

- 満足度・活気（領域IV）合計: ${globalScaleScores.job_satisfaction + globalScaleScores.life_satisfaction}点 (高ければ満足度・活気が高い)
  - 仕事の満足度: ${globalScaleScores.job_satisfaction}点
  - 生活の満足度: ${globalScaleScores.life_life_satisfaction}点

- 高ストレス者判定: ${globalIsHighStressor ? 'はい' : 'いいえ'}
${globalIsHighStressor ? `高ストレス者と判定された理由: ${globalHighStressorReason.map(r => r.replace(/<br>/g, '')).join(' および ')}` : ''}

これらの情報に基づき、具体的で、行動に移しやすいアドバイスを簡潔にまとめてください。特に高ストレス者と判定された場合は、より具体的な行動提案を含めてください。`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvasが提供
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    adviceText.textContent = text;
                    adviceDisplay.classList.remove('hidden');
                } else {
                    adviceText.textContent = 'アドバイスの生成に失敗しました。もう一度お試しください。';
                    adviceDisplay.classList.remove('hidden');
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                adviceText.textContent = 'アドバイスの生成中にエラーが発生しました。ネットワーク接続を確認してください。';
                adviceDisplay.classList.remove('hidden');
                console.error('Error calling Gemini API:', error);
            } finally {
                adviceLoading.classList.add('hidden');
                getAdviceBtn.disabled = false;
            }
        });

        // 初期表示: 最初のステップを表示
        showStep(currentStep);
    </script>
</body>
</html>
